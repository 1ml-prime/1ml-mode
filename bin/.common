#!/bin/bash -e

if ! COMPILER="$(command -v 1ml)"; then
  cat <<EOF
The ${0##*/} script expects to have the 1ml command in PATH and the prelude.1ml
file to be in the same directory as the 1ml command.
EOF
  exit 1
fi

PRELUDE="${COMPILER%/*}/prelude.1ml"

PROJECT=".1ml-sources"

# Try to find project root directory containing $PROJECT file
ROOT="$PWD"
while ! [ -f "$ROOT/$PROJECT" ] && [[ "$ROOT" =~ / ]]; do
  ROOT="${ROOT%/*}"
done

# Fill $SOURCES[@] array with paths to source files
SOURCES=("$PRELUDE")
if [ -f "$ROOT/$PROJECT" ]; then
  while IFS= read -r LINE; do
    if [[ "$LINE" =~ \.1ml ]]; then
      SOURCES+=("$ROOT/$LINE")
    fi
  done < "$ROOT/$PROJECT"
fi
