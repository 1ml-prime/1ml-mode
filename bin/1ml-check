#!/bin/bash -e

if ! command -v 1ml > /dev/null ; then
  cat <<EOF
This script expects to have the 1ml command in PATH and the prelude.1ml to be in
the same directory as the 1ml command.
EOF
  exit 1
fi

if [ $# -ne 2 ] || ! [ -f "$1" ] || ! [ -f "$2" ]; then
  cat <<EOF
Usage: 1ml-check ORIGINAL.1ml REPLACEMENT.1ml

Runs the 1ML compiler to parse and type check the program replacing the
ORIGINAL.1ml file with the REPLACEMENT.1ml.
EOF
  exit 1
fi

PRELUDE="$(dirname "$(command -v 1ml)")/prelude.1ml"

ORIGINAL="$1"
REPLACEMENT="$2"

SOURCES_DIR="$PWD"
while ! [ -f "$SOURCES_DIR/sources" ] && [[ "$SOURCES_DIR" =~ / ]]; do
  SOURCES_DIR="${SOURCES_DIR%/*}"
done

SOURCES=("$PRELUDE")

if [ -f "$SOURCES_DIR/sources" ]; then
  while IFS= read -r LINE; do
    if [[ "$LINE" =~ \.1ml ]]; then
      SOURCE="$SOURCES_DIR/$LINE"
      if [ "$SOURCE" = "$ORIGINAL" ]; then
        SOURCES+=("$REPLACEMENT")
      else
        SOURCES+=("$SOURCE")
      fi
    fi
  done < "$SOURCES_DIR/sources"
else
  SOURCES+=("$REPLACEMENT")
fi

cat <<EOF

1ml -d ${SOURCES[@]}

EOF

1ml -d "${SOURCES[@]}"
